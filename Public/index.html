<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dash App - Final</title>
  <link rel="stylesheet" href="/output.css">
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    #chat-window { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 6px; }
    .modal { display: none; }
    .typing-indicator span {
        height: 8px; width: 8px; background-color: #9E9E9E;
        display: inline-block; border-radius: 50%; opacity: 0.4;
        animation: typing 1s infinite;
    }
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.1s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.2s; }
    @keyframes typing {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  
  <div id="error-banner" class="hidden fixed top-0 left-0 right-0 z-50 bg-red-600 text-white text-sm px-4 py-3 flex items-center justify-between shadow-lg">
    <span id="error-text">Ocorreu um erro.</span>
    <button id="error-close" class="font-bold text-lg">✕</button>
  </div>

  <div id="auth-container" class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
    <div id="login-view">
      <form id="login-form">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">Login</h2>
        <input type="text" id="login-username" placeholder="Usuário" class="border p-3 w-full mb-4 rounded-lg focus:ring-2 focus:ring-blue-500" required />
        <input type="password" id="login-password" placeholder="Senha" class="border p-3 w-full mb-4 rounded-lg focus:ring-2 focus:ring-blue-500" required />
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg w-full transition-colors">Entrar</button>
      </form>
      <p class="mt-4 text-sm text-center">Não tem conta? <a href="#" class="text-blue-500 font-semibold hover:underline toggle-view">Registre-se</a></p>
    </div>
    <div id="register-view" class="hidden">
      <form id="register-form">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">Registrar</h2>
        <input type="text" id="register-username" placeholder="Usuário" class="border p-3 w-full mb-4 rounded-lg focus:ring-2 focus:ring-green-500" required />
        <input type="password" id="register-password" placeholder="Senha" class="border p-3 w-full mb-4 rounded-lg focus:ring-2 focus:ring-green-500" required />
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg w-full transition-colors">Criar Conta</button>
      </form>
      <p class="mt-4 text-sm text-center">Já tem conta? <a href="#" class="text-blue-500 font-semibold hover:underline toggle-view">Faça Login</a></p>
    </div>
  </div>

  <div id="chat-container" class="hidden w-full max-w-6xl h-[90vh] bg-white rounded-2xl shadow-xl flex overflow-hidden">
    <aside id="sidebar" class="w-[340px] bg-gray-50 border-r border-gray-200 flex flex-col">
      <header id="sidebar-header" class="p-3 border-b border-gray-200 flex items-center gap-3">
        <img id="my-avatar" class="w-10 h-10 rounded-full object-cover" alt="Meu avatar" />
        <span id="my-username-display" class="font-semibold text-gray-800"></span>
      </header>
      <div class="p-3 border-b border-gray-200">
        <input type="text" id="search-input" placeholder="Procurar usuário..." class="w-full bg-white p-2 rounded-lg border focus:ring-2 focus:ring-blue-400" />
      </div>
      <div class="overflow-y-auto flex-grow">
        <ul id="conversation-list" class="p-2"></ul>
      </div>
    </aside>
    <main id="main-chat" class="flex-1 flex flex-col bg-gray-100">
      <div id="welcome-message" class="m-auto text-center text-gray-500 flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-24 h-24 text-gray-300"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.76 9.76 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.455.09-.934.09-1.425v-2.134c0-2.616.22-5.18 1.352-7.41a6.458 6.458 0 0 1 1.08-1.518c.318-.445.654-.852 1.026-1.233A7.48 7.48 0 0 1 12 4.5c4.97 0 9 3.694 9 8.25Z" /></svg>
        <h2 class="text-2xl mt-4 font-light">Seu App de Mensagens</h2>
        <p>Procure por um usuário e selecione-o para começar.</p>
      </div>
      <header id="chat-header" class="hidden p-3 bg-white border-b border-gray-200 flex items-center justify-between">
         <div id="chat-header-info" class="flex items-center gap-3"></div>
         <div id="typing-indicator-container" class="hidden items-center gap-2 text-sm text-gray-500 mr-4">
           <div class="typing-indicator"><span></span><span></span><span></span></div>
           <span id="typing-username"></span>
         </div>
      </header>
      <div id="chat-window" class="hidden flex-1 p-6 overflow-y-auto">
        <ul id="messages" class="space-y-2"></ul>
      </div>
      <form id="message-form" class="hidden p-3 bg-gray-100 border-t items-center gap-3">
        <input id="message-input" type="text" placeholder="Digite uma mensagem" class="w-full bg-white p-3 rounded-lg border focus:ring-2 focus:ring-blue-500" autocomplete="off" />
        <button type="submit" class="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 flex-shrink-0 transition-transform hover:scale-110">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
        </button>
      </form>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const el = {
        authContainer: document.getElementById('auth-container'), loginView: document.getElementById('login-view'), registerView: document.getElementById('register-view'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), toggleLinks: document.querySelectorAll('.toggle-view'), chatContainer: document.getElementById('chat-container'), chatHeader: document.getElementById('chat-header'), chatHeaderInfo: document.getElementById('chat-header-info'), typingIndicator: document.getElementById('typing-indicator-container'), typingUsername: document.getElementById('typing-username'), messages: document.getElementById('messages'), conversationList: document.getElementById('conversation-list'), searchInput: document.getElementById('search-input'), messageForm: document.getElementById('message-form'), messageInput: document.getElementById('message-input'), chatWindow: document.getElementById('chat-window'), welcomeMessage: document.getElementById('welcome-message'), myAvatar: document.getElementById('my-avatar'), myUsernameDisplay: document.getElementById('my-username-display'), errorBanner: document.getElementById('error-banner'), errorText: document.getElementById('error-text'), errorClose: document.getElementById('error-close'),
      };

      let socket, myUsername = '', currentRoom = '', onlineUserList = [], userAvatars = {}, typingTimer;
      const defaultAvatar = `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="24" r="14" fill="#cbd5e1"/><rect x="10" y="40" width="44" height="18" rx="9" fill="#cbd5e1"/></svg>`)}`;
      
      const showError = (msg = 'Ocorreu um erro desconhecido.') => { el.errorText.textContent = msg; el.errorBanner.classList.remove('hidden'); };
      const safeHTML = (str) => (str || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      const renderUserList = (usersToRender) => {
        const activeUsername = el.conversationList.querySelector('li.active')?.dataset.username;
        el.conversationList.innerHTML = '';
        usersToRender.forEach(user => {
          if (!user || user === myUsername) return;
          const item = document.createElement('li');
          item.dataset.username = user;
          item.className = 'flex items-center gap-3 p-2 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors';
          if (user === activeUsername) item.classList.add('active', 'bg-blue-500', 'text-white', 'hover:bg-blue-500');
          item.onclick = () => selectChat(user);
          item.innerHTML = `<div class="relative"><img src="${userAvatars[user] || defaultAvatar}" class="w-10 h-10 rounded-full object-cover" alt="${safeHTML(user)}"><div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-green-500"></div></div><div class="flex-grow overflow-hidden"><div class="font-semibold truncate">${safeHTML(user)}</div></div>`;
          el.conversationList.appendChild(item);
        });
      };

      const displayMessage = (data) => {
        const { author, message, timestamp } = data;
        const ts = new Date(timestamp || Date.now());
        const li = document.createElement('li');
        const isMyMessage = author === myUsername;
        li.className = `flex w-full ${isMyMessage ? 'justify-end' : 'justify-start'}`; // <-- CORREÇÃO DA POSIÇÃO
        li.innerHTML = `<div class="flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}"><div class="${isMyMessage ? 'bg-green-100' : 'bg-white'} rounded-lg py-2 px-3 shadow-sm max-w-md"><p class="text-sm text-gray-800">${safeHTML(message)}</p><div class="text-xs text-gray-400 text-right mt-1">${String(ts.getHours()).padStart(2, '0')}:${String(ts.getMinutes()).padStart(2, '0')}</div></div></div>`;
        el.messages.appendChild(li);
        el.chatWindow.scrollTop = el.chatWindow.scrollHeight;
      };
      
      const selectChat = (targetUsername) => {
        if (!targetUsername) return;
        currentRoom = [myUsername, targetUsername].sort().join('-');
        el.chatHeaderInfo.innerHTML = `<img src="${userAvatars[targetUsername] || defaultAvatar}" class="w-10 h-10 rounded-full object-cover" alt="${safeHTML(targetUsername)}" /><span class="font-bold text-gray-800">${safeHTML(targetUsername)}</span>`;
        el.welcomeMessage.classList.add('hidden');
        ['chatHeader', 'chatWindow', 'messageForm'].forEach(id => { el[id].classList.remove('hidden'); el[id].classList.add('flex'); });
        el.messages.innerHTML = '';
        document.querySelectorAll('#conversation-list li').forEach(li => li.classList.remove('active', 'bg-blue-500', 'text-white', 'hover:bg-blue-500'));
        const userListItem = document.querySelector(`#conversation-list li[data-username="${targetUsername}"]`);
        userListItem?.classList.add('active', 'bg-blue-500', 'text-white', 'hover:bg-blue-500');
        socket.emit('join room', currentRoom);
        el.messageInput.focus();
      };

      const setupSocketListeners = () => {
        socket.on('connect_error', (err) => showError(`Falha na conexão: ${err.message}`));
        socket.on('update user list', (users) => { onlineUserList = users || []; renderUserList(onlineUserList); });
        socket.on('chat history', (history) => (history || []).forEach(displayMessage));
        socket.on('chat message', (data) => { if (data?.room === currentRoom) { el.typingIndicator.classList.replace('flex', 'hidden'); displayMessage(data); } });
        // Lógica de "digitando..."
        socket.on('user typing start', (data) => { if (data?.username !== myUsername) { el.typingUsername.textContent = `${safeHTML(data.username)} está digitando...`; el.typingIndicator.classList.replace('hidden', 'flex'); } });
        socket.on('user typing stop', () => el.typingIndicator.classList.replace('flex', 'hidden'));
      };

      const fetchUsersData = async () => { try { const response = await fetch('/api/users', { headers: { Authorization: `Bearer ${localStorage.getItem('chat_token')}` } }); if (!response.ok) throw new Error('Falha ao buscar dados dos usuários'); const users = await response.json(); userAvatars = (users || []).reduce((acc, user) => { if (user?.username) acc[user.username] = user.avatar_url || defaultAvatar; return acc; }, {}); el.myAvatar.src = userAvatars[myUsername] || defaultAvatar; } catch (err) { showError(err.message); } };
      
      const initializeChat = async (username, token) => {
          myUsername = username;
          localStorage.setItem('chat_token', token);
          el.myUsernameDisplay.textContent = myUsername;
          el.authContainer.classList.add('hidden');
          el.chatContainer.classList.remove('hidden');
          await fetchUsersData();
          if (typeof io === 'undefined') { showError('Biblioteca Socket.IO não encontrada.'); return; }
          socket = io({ auth: { token } });
          setupSocketListeners();
      };

      const handleLogin = async (e) => { e.preventDefault(); const username = el.loginForm.querySelector('#login-username').value.trim(); const password = el.loginForm.querySelector('#login-password').value; try { const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }), }); const result = await res.json(); if (!res.ok || !result.token) throw new Error(result.message || 'Falha no login'); initializeChat(result.username, result.token); } catch (err) { showError(err.message); } };
      const handleRegister = async (e) => { e.preventDefault(); const username = el.registerForm.querySelector('#register-username').value.trim(); const password = el.registerForm.querySelector('#register-password').value; try { const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }), }); const result = await res.json(); if (!res.ok) throw new Error(result.message || 'Falha ao registrar'); alert('Cadastro realizado! Agora você pode fazer o login.'); el.toggleLinks[1].click(); } catch (err) { showError(err.message); } };

      el.loginForm.addEventListener('submit', handleLogin);
      el.registerForm.addEventListener('submit', handleRegister);
      el.messageForm.addEventListener('submit', (e) => { e.preventDefault(); const message = el.messageInput.value.trim(); if (message && currentRoom) { socket.emit("chat message", { room: currentRoom, message }); el.messageInput.value = ''; el.messageInput.focus(); clearTimeout(typingTimer); socket.emit('user typing stop', { room: currentRoom }); } });
      el.searchInput.addEventListener('input', () => { const searchTerm = el.searchInput.value.toLowerCase().trim(); const usersToRender = searchTerm ? onlineUserList.filter(u => u.toLowerCase().includes(searchTerm)) : []; renderUserList(usersToRender); });
      el.toggleLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); el.loginView.classList.toggle('hidden'); el.registerView.classList.toggle('hidden'); }));
      el.errorClose.onclick = () => el.errorBanner.classList.add('hidden');
      
      // Lógica de "digitando..."
      el.messageInput.addEventListener('input', () => {
          clearTimeout(typingTimer);
          socket.emit('user typing start', { room: currentRoom });
          typingTimer = setTimeout(() => socket.emit('user typing stop', { room: currentRoom }), 1500);
      });
    });
  </script>
</body>
</html>